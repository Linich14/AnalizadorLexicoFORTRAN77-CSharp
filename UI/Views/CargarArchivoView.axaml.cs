using Avalonia;
using Avalonia.Controls;
using Avalonia.Markup.Xaml;
using Avalonia.Interactivity;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System;
using System.Text;
using AnalizadorLexico.Lexico;
using AnalizadorLexico.Sintaxis;

namespace AnalizadorLexico.UI.Views;

public class InformacionArchivo
{
    public string Nombre { get; set; } = string.Empty;
    public long Tamanio { get; set; }
    public string RutaCompleta { get; set; } = string.Empty;
}

public partial class CargarArchivoView : UserControl
{
    public ObservableCollection<InformacionArchivo> ArchivosDisponibles { get; } = new ObservableCollection<InformacionArchivo>();
    
    // Propiedades usando FindControl para evitar conflictos con generaci√≥n autom√°tica
    private ComboBox? _cmbFiles;
    private Button? _btnRefreshFiles;
    private Button? _btnAnalyzeFile;
    private TextBlock? _txtFileInfo;
    private TextBox? _outputSourceCode;
    private TextBox? _outputTokensResult;
    private TextBox? _outputMessages;
    
    private ComboBox? CmbFiles => _cmbFiles ??= this.FindControl<ComboBox>("FilesCombo");
    private Button? BtnRefreshFiles => _btnRefreshFiles ??= this.FindControl<Button>("RefreshBtn");
    private Button? BtnAnalyzeFile => _btnAnalyzeFile ??= this.FindControl<Button>("AnalyzeBtn");
    private TextBlock? TxtFileInfo => _txtFileInfo ??= this.FindControl<TextBlock>("FileInfoLabel");
    private TextBox? OutputSourceCode => _outputSourceCode ??= this.FindControl<TextBox>("SourceCodeArea");
    private TextBox? OutputTokensResult => _outputTokensResult ??= this.FindControl<TextBox>("TokensArea");
    private TextBox? OutputMessages => _outputMessages ??= this.FindControl<TextBox>("MessagesArea");

    public CargarArchivoView()
    {
        InitializeComponent();
        
        this.AttachedToVisualTree += (s, e) =>
        {
            InicializarControles();
            CargarArchivosDisponibles();
        };
    }

    private void InitializeComponent()
    {
        AvaloniaXamlLoader.Load(this);
    }
    
    private void InicializarControles()
    {
        if (CmbFiles != null)
        {
            CmbFiles.ItemsSource = ArchivosDisponibles;
            CmbFiles.SelectionChanged += CuandoCambiaSeleccionArchivo;
        }
        
        if (BtnRefreshFiles != null)
            BtnRefreshFiles.Click += CuandoClickRefrescar;
            
        if (BtnAnalyzeFile != null)
            BtnAnalyzeFile.Click += CuandoClickAnalizar;
    }

    private void CargarArchivosDisponibles()
    {
        ArchivosDisponibles.Clear();

        string rutaInput = Path.Combine(Directory.GetCurrentDirectory(), "input");

        if (Directory.Exists(rutaInput))
        {
            var archivos = Directory.GetFiles(rutaInput, "*.*")
                .Where(archivo => archivo.EndsWith(".txt", StringComparison.OrdinalIgnoreCase) ||
                                 archivo.EndsWith(".f77", StringComparison.OrdinalIgnoreCase) ||
                                 archivo.EndsWith(".for", StringComparison.OrdinalIgnoreCase))
                .Select(archivo => new InformacionArchivo
                {
                    Nombre = Path.GetFileName(archivo),
                    Tamanio = new FileInfo(archivo).Length,
                    RutaCompleta = archivo
                })
                .OrderBy(archivo => archivo.Nombre);

            foreach (var archivo in archivos)
            {
                ArchivosDisponibles.Add(archivo);
            }
        }
    }

    private void CuandoCambiaSeleccionArchivo(object? sender, SelectionChangedEventArgs e)
    {
        var archivoSeleccionado = CmbFiles?.SelectedItem as InformacionArchivo;
        
        if (archivoSeleccionado != null)
        {
            if (TxtFileInfo != null)
                TxtFileInfo.Text = $"{archivoSeleccionado.Nombre} ({archivoSeleccionado.Tamanio} bytes) - {archivoSeleccionado.RutaCompleta}";
            
            if (BtnAnalyzeFile != null)
                BtnAnalyzeFile.IsEnabled = true;
        }
        else
        {
            if (TxtFileInfo != null)
                TxtFileInfo.Text = "Selecciona un archivo de la carpeta 'input/'";
            
            if (BtnAnalyzeFile != null)
                BtnAnalyzeFile.IsEnabled = false;
        }
        
        // Limpiar resultados anteriores
        LimpiarResultados();
    }

    private void CuandoClickRefrescar(object? sender, RoutedEventArgs e)
    {
        CargarArchivosDisponibles();
        if (CmbFiles != null)
            CmbFiles.SelectedIndex = -1;
        LimpiarResultados();
    }

    private void CuandoClickAnalizar(object? sender, RoutedEventArgs e)
    {
        var archivoSeleccionado = CmbFiles?.SelectedItem as InformacionArchivo;
        if (archivoSeleccionado == null)
            return;

        try
        {
            // Leer el contenido del archivo
            string codigoFuente = File.ReadAllText(archivoSeleccionado.RutaCompleta);

            // Mostrar c√≥digo fuente
            if (OutputSourceCode != null)
            {
                var sb = new StringBuilder();
                sb.AppendLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
                sb.AppendLine($"  ARCHIVO: {archivoSeleccionado.Nombre}");
                sb.AppendLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
                sb.AppendLine();
                sb.AppendLine(codigoFuente);
                OutputSourceCode.Text = sb.ToString();
            }

            // FASE 1: An√°lisis L√©xico
            var lexer = new Lexer(codigoFuente);
            var tokens = lexer.Tokenizar().ToList();

            // Mostrar tokens
            MostrarTokens(tokens);

            // FASE 2: An√°lisis Sint√°ctico
            var stopwatch = System.Diagnostics.Stopwatch.StartNew();
            var parser = new Parser(tokens);
            var arbolSintactico = parser.ParsePrograma();
            stopwatch.Stop();

            // Actualizar MainWindow con el archivo y √°rbol cargado
            var ventanaPrincipal = this.VisualRoot as MainWindow;
            if (ventanaPrincipal == null)
                ventanaPrincipal = MainWindow.Instance;
            
            if (ventanaPrincipal != null)
            {
                ventanaPrincipal.CargarArchivo(archivoSeleccionado.RutaCompleta);
                ventanaPrincipal.ActualizarArbolSintactico(arbolSintactico, stopwatch.ElapsedMilliseconds);
            }

            // Mensaje de √©xito
            if (OutputMessages != null)
            {
                var msg = new StringBuilder();
                msg.AppendLine("‚úì AN√ÅLISIS COMPLETADO EXITOSAMENTE");
                msg.AppendLine();
                msg.AppendLine($"Archivo: {archivoSeleccionado.Nombre}");
                msg.AppendLine($"Tama√±o: {archivoSeleccionado.Tamanio} bytes");
                msg.AppendLine($"Tokens generados: {tokens.Count(t => t.Tipo != TipoToken.EOF && t.Tipo != TipoToken.EOL)}");
                msg.AppendLine($"Sentencias: {arbolSintactico.Sentencias.Count}");
                msg.AppendLine($"Tiempo de an√°lisis: {stopwatch.ElapsedMilliseconds} ms");
                msg.AppendLine();
                msg.AppendLine("El c√≥digo es sint√°cticamente correcto seg√∫n la gram√°tica FORTRAN77 implementada.");
                msg.AppendLine();
                msg.AppendLine("üí° Navega a '√Årbol Sint√°ctico' en el men√∫ lateral para ver la visualizaci√≥n completa.");
                OutputMessages.Text = msg.ToString();
            }

            // Cambiar a la pesta√±a de tokens autom√°ticamente
            var tabControl = this.FindControl<TabControl>("TabResults");
            if (tabControl != null)
                tabControl.SelectedIndex = 1; // Pesta√±a de tokens
        }
        catch (Exception ex)
        {
            MostrarError($"Error durante el an√°lisis:\n\n{ex.Message}");
        }
    }

    private void MostrarTokens(System.Collections.Generic.List<Token> tokens)
    {
        if (OutputTokensResult == null) return;

        var resultado = new StringBuilder();
        resultado.AppendLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        resultado.AppendLine("  TOKENS GENERADOS POR EL ANALIZADOR L√âXICO");
        resultado.AppendLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        resultado.AppendLine();
        resultado.AppendLine($"Total de tokens: {tokens.Count(t => t.Tipo != TipoToken.EOF && t.Tipo != TipoToken.EOL)}");
        resultado.AppendLine();
        resultado.AppendLine("‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
        resultado.AppendLine("‚îÇ #   ‚îÇ Tipo                 ‚îÇ Lexema         ‚îÇ Posici√≥n ‚îÇ");
        resultado.AppendLine("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");

        int contador = 1;
        foreach (var token in tokens)
        {
            if (token.Tipo == TipoToken.EOF) continue;
            if (token.Tipo == TipoToken.EOL) continue;

            var tipo = token.Tipo.ToString().PadRight(20);
            var lexema = token.Lexema.Length > 14 ? token.Lexema.Substring(0, 11) + "..." : token.Lexema.PadRight(14);
            var posicion = $"{token.Linea}:{token.Columna}".PadRight(8);

            resultado.AppendLine($"‚îÇ {contador.ToString().PadLeft(3)} ‚îÇ {tipo} ‚îÇ {lexema} ‚îÇ {posicion} ‚îÇ");
            contador++;
        }

        resultado.AppendLine("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");

        OutputTokensResult.Text = resultado.ToString();
    }

    private void MostrarError(string mensaje)
    {
        if (OutputMessages != null)
        {
            OutputMessages.Text = "‚úó ERROR\n\n" + mensaje;
        }

        // Cambiar a la pesta√±a de mensajes
        var tabControl = this.FindControl<TabControl>("TabResults");
        if (tabControl != null)
        {
            tabControl.SelectedIndex = 2; // Pesta√±a de mensajes (ahora es la tercera)
        }
    }

    private void LimpiarResultados()
    {
        if (OutputSourceCode != null) OutputSourceCode.Text = string.Empty;
        if (OutputTokensResult != null) OutputTokensResult.Text = string.Empty;
        if (OutputMessages != null) OutputMessages.Text = "Selecciona un archivo y presiona 'Analizar Archivo' para ver los resultados.";
    }
}